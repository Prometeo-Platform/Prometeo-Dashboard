import React, { useContext, useEffect, useState } from 'react';
import { useNavigate } from 'react-router-dom';
import DeviceTable from '../../components/DeviceTable';
import DeviceMap from '../../components/DeviceMap';
import useMap from '../../hooks/useMap';
import AppContext from '../../context/app';

const processDeviceData = (devices) => {
  return devices.slice().map((s) => ({
    ...s,
    statusColor: (() => {
      if (!s.lastCheckin) {
        return 'yellow';
      }

      const secondsAgo =
        Math.floor(Date.now() / 1000) -
        Math.floor(new Date(s.lastCheckin) / 1000);

      if (secondsAgo > 604800) {
        return 'yellow';
      }

      return 'green';
    })(),
  }));
};

const MapPage = (props) => {
  const { t, currentUser, setCurrentUser, addToast } = useContext(AppContext);

  const navigate = useNavigate();

  const active = props.active;
  const language = props.language;
  // const page = props.page;
  const setActive = props.setActive;
  // const setPage = props.setPage;

  /*
  const [execQuery, { map, loading }] = useLazyQuery(GET_DEVICES, {
    errorPolicy: 'all',
    // TODO
    onError() {
      addToast({
        kind: 'warning',
        caption:
          'There were errors generated by the device query that may affect the display of relevant data. If this is a recurring warning, consider opening an issue.',
        title: 'Device Data Loaded with Error(s)',
      })
    },
  })
  */

  const [loading, setLoading] = useState('Loading...');

  const [pageSize, setPageSize] = useState(5);
  const [page, setPage] = useState(1);
  const [devices, setDevices] = useState([]);
  const [currentlyVisibleDevice, setCurrentlyVisibleDevice] = useState([]);

  const [shouldShowSideMenu, setShouldShowSideMenu] = useState(false);
  const [displayedDevice, setDisplayedDevice] = useState({});
  const [currentHoveredDevice, setCurrentHoveredDevice] = useState();

  /*
  useEffect(() => {
    execQuery()
  }, [execQuery])
  */

  const [
    // loading,
    // setLoading,
    map,
    // setDashboard,
    normal,
    // setNormal,
    warning,
    // setWarning,
    danger,
    // setDanger,
  ] = useMap();

  useEffect(() => {
    if (map && map.devices) {
      console.log('useEffect map', map);
      console.log('useEffect devices', map.devices);
      setDevices(processDeviceData(map.devices));
    }
  }, [map]);

  useEffect(() => {
    setCurrentlyVisibleDevice(
      devices.slice((page - 1) * pageSize, page * pageSize)
    );
  }, [page, pageSize, devices]);

  const onPaginationChange = (paginationInfo) => {
    setPage(paginationInfo.page);
    setPageSize(paginationInfo.pageSize);
  };

  const onDeviceHover = (index) => {
    setCurrentHoveredDevice(index);
  };

  return (
    <div className="bx--grid bx--grid--full-width map-content">
      <div className="bx--row">
        <div className="bx--col-md-16">
          <h1 className="map-page__heading">{t('content.map.heading')}</h1>
        </div>
      </div>

      <div className="bx--row">
        <div className="bx--col-md-16">
          <h2 className="map-page__subheading">
            {t('content.map.subheading')}
          </h2>
        </div>
      </div>

      <div className="device-map__container">
        <DeviceMap
          devices={devices}
          setDisplayedDevice={setDisplayedDevice}
          setShouldShowSideMenu={setShouldShowSideMenu}
          onDeviceHover={onDeviceHover}
          currentHoveredDevice={currentHoveredDevice}
        />
      </div>

      <div className="device-table__container">
        <DeviceTable
          loading={loading}
          navigate={navigate}
          devices={devices}
          setDevices={setDevices}
          page={page}
          pageSize={pageSize}
          onPaginationChange={onPaginationChange}
          currentlyVisibleDevice={currentlyVisibleDevice}
          shouldShowSideMenu={shouldShowSideMenu}
          setShouldShowSideMenu={setShouldShowSideMenu}
          displayedDevice={displayedDevice}
          setDisplayedDevice={setDisplayedDevice}
          onDeviceHover={onDeviceHover}
          currentHoveredDevice={currentHoveredDevice}
        />
      </div>
    </div>
  );
};

export default MapPage;
